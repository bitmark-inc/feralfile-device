<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Feral File Minimal Artwork Player</title>
<style>
  html,body{margin:0;height:100%;background:#000;color:#fff;font-family:sans-serif}
  #stage{position:relative;width:100vw;height:100vh;overflow:hidden;background:#000}
  #stage>img, #stage>video, #stage>iframe{width:100%;height:100%;background:#000}
</style>
<script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
</head>
<body>

<div id="stage"></div>

<script>
 /* ---------------------------------- CONSTANTS ----------------------------------- */
const MIMETypeStreamVideo = ["application/x-mpegurl", "m3u8"];
const MITETypeIframe = ["html", "text/html", "text/plain"];
const MIMETypeVideo = "video/*";
const MIMETypeAudio = "audio/*";
const MIMETypeImage = "image/*";
const MIMETypeObject = "text/csv";
const MIMETypePdf = "application/pdf";
const FileUseObject = ["txt"];
const FileUseVideo = ["mp4", "mov", "wmv", "quicktime", "avi", "webm", "mkv"];
const FileUseAudio = ["mp3", "m4a", "wav", "wma", "aac"];
const FileUseImage = ["png", "jpg", "jpeg", "bmp", "gif", "svg", "application/xml"];
const FileUseIframePDF = ["pdf", "application/pdf"];

/* ---------------------------------- VARIABLES ----------------------------------- */
const stage  = document.getElementById('stage');

let mode = 'fit';                     // 'fit' | 'fill'
let currentEl = null;                 // <img> or <video> or <audio> or <iframe>
let isStreaming = false;
const CLIENT_BANDWIDTH_HINT = 16; // Default value for bandwidth hint

function applyMode(el){
  if(!el) return;

  el.style.objectFit = mode === 'fill' ? 'cover' : 'contain';
}

function setSrc(url, mimeType){
  if(currentEl) stage.removeChild(currentEl);

  if (!url) return;

  const type = mimeType || url.split('.').pop().toLowerCase();
  const el = fileTypeToPlayerElement(type, url);
  el.onload = el.onloadeddata = () => {
    el.focus();
  };
  applyMode(el);
  stage.appendChild(el);
  currentEl = el;
}

function setImageElement(url) {
  const el = document.createElement('img');
  el.src = url;
  el.style.width = '100%';
  el.style.height = '100%';
  el.style.inset = '0px';
  el.style.color = 'transparent';
  el.alt = 'artwork preview';

  return el;
}

function setObjectElement(url) {
  const el = document.createElement('object');
  el.data = url;
  el.style.width = '100%';
  el.style.height = '100%';
  el.type = 'text/html';

  return el;
}

function setVideoElementWithoutSrc() {
  const el = document.createElement('video');
  el.autoplay = true;
  el.loop = true;
  el.playsInline = true;
  el.controls = false;
  el.style.width = '100%';
  el.style.height = '100%';
  el.crossOrigin = 'anonymous';

  return el;
}

function retryToPlayVideo(el) {
  if (el && el instanceof HTMLVideoElement) {
    el.muted = true;
    el.play().catch((error) => {
      console.log("[ArtworkPlayer] Error play video", JSON.stringify(error));
    });
  }
}

function setStreamElement(url, el) {
  if (isStreaming && Hls.isSupported() && url.endsWith(".m3u8")) {
    const hls = new Hls({
      maxBufferSize: 60 * 1000 * 1000,
      maxBufferLength: 30,
      liveSyncDuration: 10,
    });

    hls.attachMedia(el);
    hls.on(Hls.Events.MEDIA_ATTACHED, () => {
      hls.loadSource(
        `${url}?clientBandwidthHint=${CLIENT_BANDWIDTH_HINT.toString()}`
      );
      el
        ?.play()
        .catch((error) => {
          console.log("Error play video", error);
        })
    });

    hls.on(Hls.Events.ERROR, function (event, data) {
      switch (data.type) {
        case Hls.ErrorTypes.NETWORK_ERROR:
          break;
        case Hls.ErrorTypes.MEDIA_ERROR:
          if (data.details === Hls.ErrorDetails.BUFFER_NUDGE_ON_STALL) {
            console.log("Buffer stall detected, attempting to recover...");
            hls.recoverMediaError();
          }
          break;
        default:
          console.error("An unrecoverable error occurred");
          hls.destroy();
          break;
      }
    });
  }
}

function setAudioElement(url) {
  const el = document.createElement('audio');
  el.src = url;
  el.autoplay = true;
  el.loop = true;
  el.controls = false;

  return el;
}

function setIframeElement(url) {
  const el = document.createElement('iframe');
  el.src = url;
  el.style.width = '100%';
  el.style.height = '100%';
  el.style.border = 'none';
  el.tabIndex = 0;
  el.sandbox = 'allow-same-origin allow-scripts';

  return el;
}

function fileTypeToPlayerElement(type, url) {
  isStreaming = false;
  if (!type) {
    return;
  }
  type = type.toLowerCase();

  let el;

  if (MIMETypeStreamVideo.includes(type)) {
    isStreaming = true;
    el = setVideoElementWithoutSrc();
    setStreamElement(url, el);
  } else if (MITETypeIframe.includes(type)) {
    el = setIframeElement(url);
  } else if (FileUseObject.includes(type) || type.match(MIMETypeObject)) {
    el = setObjectElement(url);
  } else if (FileUseVideo.includes(type) || type.match(MIMETypeVideo)) {
    el = setVideoElementWithoutSrc();
    el.src = url;
    el.play().catch((error) => {
      console.log("[ArtworkPlayer] Error play video", JSON.stringify(error));
      retryToPlayVideo(el);
    });

  } else if (FileUseAudio.includes(type) || type.match(MIMETypeAudio)) {
    el = setAudioElement(url);
  } else if (FileUseImage.includes(type) || type.match(MIMETypeImage)) {
    el = setImageElement(url);
  } else if (FileUseIframePDF.includes(type) || type.match(MIMETypePdf)) {
    el = setIframeElement(url);
  } else {
    el = setIframeElement(url);
  }

  return el;
}

/* ---------------------- expose to external scripts ---------------------------- */
async function setArtwork({ url, mimeType, mode: newMode }){
  if(newMode === 'fit' || newMode === 'fill'){
    mode = newMode;
    applyMode(currentEl);
  }
  if(url) setSrc(url, mimeType);
  return { ok:true };
}
window.setArtwork = setArtwork;       // <-- external API

</script>
</body>
</html>
